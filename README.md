# Semantic Builder - è¯­ä¹‰ 3D å»ºå›¾ç³»ç»Ÿ

å¯åŠ¨ç›¸æœº
ros2 launch realsense2_camera rs_launch.py   enable_color:=true   rgb_camera.profile:=640,480,30   enable_depth:=true   depth_module.profile:=640,480,30   align_depth.enable:=true   enable_infra1:=false   enable_infra2:=false   enable_sync:=true enable_gyro:=true enable_accel:=true enable_sync:=true unite_imu_method:=2 gyro_fps:=200 accel_fps:=250

å½•åˆ¶bagæ–‡ä»¶
ros2 bag record -o bag1     /camera/color/image_raw     /camera/aligned_depth_to_color/image_raw     /camera/color/camera_info     /camera/imu     /tf_static

ä¼ è¾“æ–‡ä»¶
scp -r /home/nvidia/SenseBettle_vision/bag1 jj@192.168.8.30:/home/jj/project_total/camera_ws/src/semantic_builder/map/

å¯åŠ¨å»ºå›¾
# ç»ˆç«¯1
export ROS_DOMAIN_ID=10
ros2 bag play <æ–°çš„bagè·¯å¾„> --clock -r 0.5
# ç»ˆç«¯2
export ROS_DOMAIN_ID=10
ros2 launch semantic_builder offline_process.launch.py

---

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

- **åŒæ¨¡å»ºå›¾**ï¼šæ”¯æŒâ€œè¾¹èµ°è¾¹çœ‹â€çš„å®æ—¶é¢„è§ˆæ¨¡å¼ï¼Œå’Œâ€œå…ˆå½•åç®—â€çš„é«˜ç²¾åº¦ç¦»çº¿æ¨¡å¼ã€‚
- **è¯­ä¹‰èåˆ**ï¼šåˆ©ç”¨ TSDF ç®—æ³•å°† YOLO çš„è¯­ä¹‰åˆ†å‰²ç»“æœå®æ—¶èåˆåˆ° 3D ç½‘æ ¼ä¸­ã€‚
- **å»å™ªä¼˜åŒ–**ï¼šè‡ªåŠ¨è¿‡æ»¤ 3ç±³ä»¥å¤–çš„ä¸ç¨³å®šæ·±åº¦æ•°æ®ï¼Œå¹¶é€šè¿‡ä½“ç´ èåˆå»é™¤éšæœºå™ªå£°ã€‚
- **ä¸€é”®ä¿å­˜**ï¼šCtrl+C è‡ªåŠ¨ä¿å­˜ `.ply` æ ¼å¼çš„å½©è‰²è¯­ä¹‰ç½‘æ ¼ (Mesh) å’Œç‚¹äº‘ (Cloud)ã€‚

---

## ğŸ› ï¸ å®‰è£…ä¸ç¼–è¯‘

```bash
# 1. å®‰è£…ä¾èµ–
pip install open3d ultralytics

# 2. ç¼–è¯‘å·¥ä½œç©ºé—´
cd ~/camera_ws
colcon build --packages-select semantic_builder --symlink-install
source install/setup.bash
```

---

## ğŸ’¾ å¦‚ä½•ä¿å­˜ä¸æŸ¥çœ‹ (æ ¸å¿ƒæ“ä½œ)

### 1. å¦‚ä½•ä¿å­˜åœ°å›¾
åœ¨å»ºå›¾è¿‡ç¨‹ä¸­ï¼ˆæ— è®ºæ˜¯åœ¨çº¿è¿˜æ˜¯ç¦»çº¿æ¨¡å¼ï¼‰ï¼Œ**åªéœ€è¦åœ¨ç»ˆç«¯æŒ‰ä¸€æ¬¡ `Ctrl+C`**ã€‚
- ç³»ç»Ÿä¼šè‡ªåŠ¨æ•è·å…³é—­ä¿¡å·ã€‚
- **è¯·è€å¿ƒç­‰å¾… 2-3 ç§’**ï¼Œç›´åˆ°ç»ˆç«¯æ‰“å°å‡º `âœ… ç½‘æ ¼å·²ä¿å­˜` å’Œ `âœ… ç‚¹äº‘å·²ä¿å­˜` çš„æ—¥å¿—ã€‚
- æ–‡ä»¶ä¼šè‡ªåŠ¨ä¿å­˜åˆ°ï¼š`src/semantic_builder/map/` ç›®å½•ä¸‹ï¼Œæ–‡ä»¶ååŒ…å«å½“å‰æ—¶é—´æˆ³ã€‚

### 2. ç”Ÿæˆäº†ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ
æ¯æ¬¡ä¿å­˜éƒ½ä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š
- **`semantic_mesh_xxxx.ply` (æ¨è)**ï¼šè¿ç»­çš„**ä¸‰è§’ç½‘æ ¼**æ¨¡å‹ã€‚è¡¨é¢å…‰æ»‘ï¼Œæœ‰ç«‹ä½“æ„Ÿï¼Œè§‚æ„Ÿæœ€ä½³ã€‚
- **`semantic_cloud_xxxx.ply`**ï¼šç¦»æ•£çš„**ç‚¹äº‘**æ–‡ä»¶ã€‚æ–‡ä»¶è¾ƒå°ï¼Œé€‚åˆç®—æ³•å¤„ç†ï¼Œä½†è¿‘çœ‹æœ‰ç¼éš™ã€‚

### 3. å¦‚ä½•æ‰“å¼€æŸ¥çœ‹ï¼Ÿ

#### æ–¹æ³• Aï¼šåŒå‡»ç›´æ¥æŸ¥çœ‹ (æœ€ç®€å•)
åœ¨ç»ˆç«¯è¾“å…¥ä»¥ä¸‹å‘½ä»¤æ‰“å¼€æ–‡ä»¶å¤¹ï¼Œç„¶åç›´æ¥åŒå‡» `.ply` æ–‡ä»¶å³å¯ï¼š
```bash
xdg-open src/semantic_builder/map/
```

#### æ–¹æ³• Bï¼šä½¿ç”¨ MeshLab æŸ¥çœ‹ (æ•ˆæœæœ€å¥½)
Ubuntu é»˜è®¤æŸ¥çœ‹å™¨å¯èƒ½ä¸æ”¯æŒå¤æ‚çš„é¡¶ç‚¹é¢œè‰²ï¼Œæ¨èå®‰è£… MeshLabï¼š
```bash
sudo apt install meshlab
meshlab src/semantic_builder/map/semantic_mesh_2026xxxx.ply
```

#### æ–¹æ³• Cï¼šè½¬æ¢æ ¼å¼åœ¨æ‰‹æœº/ç½‘é¡µæŸ¥çœ‹
å°† `.ply` è½¬æ¢ä¸ºé€šç”¨çš„ `.glb` æ ¼å¼ï¼š
```bash
# è¯­æ³•: ros2 run semantic_builder ply2gltf <è¾“å…¥.ply> [è¾“å‡º.glb]
ros2 run semantic_builder ply2gltf src/semantic_builder/map/semantic_mesh_xxxx.ply output.glb
```
ç”Ÿæˆçš„ `output.glb` å¯ä»¥ç›´æ¥å‘é€åˆ°æ‰‹æœºï¼Œæˆ–æ‹–å…¥ [glTF Viewer](https://gltf-viewer.donmccurdy.com/) æŸ¥çœ‹ã€‚

---

## ğŸ“– è¯¦ç»†ä½¿ç”¨æŒ‡å—

### æ–¹æ¡ˆ Aï¼šåœ¨çº¿å®æ—¶å»ºå›¾ (Online Mapping)
**é€‚ç”¨åœºæ™¯**ï¼šå¿«é€Ÿé¢„è§ˆã€å•æˆ¿é—´å°èŒƒå›´æ‰«æã€‚

1.  **å¯åŠ¨**ï¼š
    ```bash
    ros2 launch semantic_builder semantic_mapping.launch.py
    ```
2.  **æ‰«æ**ï¼šæ‰‹æŒç›¸æœºç¼“æ…¢ç§»åŠ¨ï¼Œä¿æŒåœ¨ç‰©ä½“ 3ç±³èŒƒå›´å†…ã€‚
3.  **ä¿å­˜**ï¼šæŒ‰ `Ctrl+C` ç»“æŸå¹¶ä¿å­˜ã€‚

### æ–¹æ¡ˆ Bï¼šç¦»çº¿é«˜ç²¾åº¦å»ºå›¾ (Offline Processing)
**é€‚ç”¨åœºæ™¯**ï¼šå…¨å±‹æ‰«æã€éœ€è¦é«˜è´¨é‡æ— é‡å½±åœ°å›¾ã€‚

1.  **ç¬¬ä¸€æ­¥ï¼šå½•åˆ¶æ•°æ®**
    ```bash
    ros2 launch semantic_builder record_data.launch.py
    ```
    - æ‹¿ç€ç›¸æœºèµ°å®Œä¸€åœˆï¼ˆå›åˆ°èµ·ç‚¹é—­ç¯ï¼‰ï¼ŒæŒ‰ `Ctrl+C` ç»“æŸå½•åˆ¶ã€‚

2.  **ç¬¬äºŒæ­¥ï¼šå¯åŠ¨å¤„ç†èŠ‚ç‚¹**
    ```bash
    ros2 launch semantic_builder offline_process.launch.py
    ```
    - ç³»ç»Ÿè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚

3.  **ç¬¬ä¸‰æ­¥ï¼šæ…¢é€Ÿæ’­æ”¾æ•°æ®**
    æ–°å¼€ç»ˆç«¯æ’­æ”¾æ•°æ®åŒ…ï¼ˆ0.5å€é€Ÿä»¥æé«˜ç²¾åº¦ï¼‰ï¼š
    ```bash
    ros2 bag play semantic_session_xxxx -r 0.5 --clock
    ```
    - æ’­æ”¾å®Œåï¼Œåœ¨**å¤„ç†èŠ‚ç‚¹**çš„ç»ˆç«¯æŒ‰ `Ctrl+C` ä¿å­˜åœ°å›¾ã€‚

---

## âš™ï¸ å‚æ•°è°ƒä¼˜æŒ‡å—

å¦‚æœé‡åˆ°å»ºå›¾æ•ˆæœä¸ç†æƒ³ï¼Œè¯·å°è¯•ä¿®æ”¹ä»¥ä¸‹å…³é”®æ–‡ä»¶ä¸­çš„å‚æ•°ï¼š

### 1. ä¿®æ”¹åœ°å›¾æ¸…æ™°åº¦ä¸å»å™ª
**æ–‡ä»¶è·¯å¾„**: `src/semantic_builder/semantic_builder/semantic_cloud_saver.py` (çº¦ç¬¬67è¡Œ)

| å‚æ•°å | å½“å‰å€¼ | è¯´æ˜ |
|--------|--------|------|
| `voxel_length` | **0.015** (1.5cm) | **ä½“ç´ å¤§å°**ã€‚å¦‚æœåœ°å›¾æ¨¡ç³Š/é©¬èµ›å…‹ï¼Œæ”¹å°ä¸º 0.01 (1cm)ï¼›å¦‚æœç”µè„‘å¡é¡¿/æ˜¾å­˜ä¸è¶³ï¼Œæ”¹å¤§ä¸º 0.02 (2cm)ã€‚ |
| `sdf_trunc` | 0.06 | **æˆªæ–­è·ç¦»**ã€‚é€šå¸¸è®¾ä¸º `voxel_length` çš„ 3-5 å€ã€‚æ”¹äº†ä½“ç´ å¤§å°æ—¶è®°å¾—æ”¹è¿™ä¸ªã€‚ |
| `depth_trunc` | **3.0** (3ç±³) | **æœ€å¤§èåˆè·ç¦»**ã€‚ç›¸æœºè¶…è¿‡ 3ç±³è¯¯å·®å¾ˆå¤§ï¼Œä¼šäº§ç”Ÿâ€œäº‘é›¾â€ã€‚å¦‚æœä½ åœ¨å¤§å…ä¸”æƒ³è¦æ‰«æ›´è¿œï¼Œå¯æ”¹ä¸º 5.0ã€‚ |

### 2. ä¿®æ”¹ SLAM å®šä½ç¨³å®šæ€§
**æ–‡ä»¶è·¯å¾„**: `src/semantic_builder/launch/semantic_mapping.launch.py` (RTAB-Map å‚æ•°éƒ¨åˆ†)

| å‚æ•°å | å½“å‰å€¼ | è¯´æ˜ |
|--------|--------|------|
| `Vis/MinDepth` | 0.2 | ç‰¹å¾ç‚¹æå–æœ€å°æ·±åº¦ã€‚ |
| `Vis/MaxDepth` | 4.0 | ç‰¹å¾ç‚¹æå–æœ€å¤§æ·±åº¦ã€‚ |
| `Grid/RangeMax` | 4.0 | 2D æ …æ ¼åœ°å›¾çš„æœ€å¤§è·ç¦»ã€‚ |
| `Reg/Strategy` | 1 | é…å‡†ç­–ç•¥ã€‚0=Visual, 1=ICP, 2=Visual+ICPã€‚å¦‚æœæ˜¯ Realsense D435iï¼Œ1 (ICP) é€šå¸¸æ›´ç¨³ã€‚ |

---

## ğŸ“ è¯é¢˜è¯´æ˜

| è¯é¢˜åç§° | è¯´æ˜ |
|---------|------|
| `/tsdf/mesh_cloud` | **RVizæ˜¾ç¤ºç”¨**ï¼Œå®æ—¶èåˆçš„è¯­ä¹‰ç½‘æ ¼ç‚¹äº‘ |
| `/yolo/overlay_image` | YOLO å®æ—¶æ£€æµ‹ç”»é¢ |
| `/yolo/semantic_mask` | è¯­ä¹‰åˆ†å‰²æ©è†œ (Mask) |

---

## âš–ï¸ å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆåœ°å›¾ä¼šæœ‰é‡å½±ï¼Ÿ**
A: è¿™æ˜¯ SLAM æ¼‚ç§»å¯¼è‡´çš„ã€‚è¯·å°è¯•**ç¦»çº¿æ¨¡å¼**å¹¶æ…¢é€Ÿæ’­æ”¾ï¼Œæˆ–åœ¨æ‰«ææ—¶ç¡®ä¿å›åˆ°èµ·ç‚¹ï¼ˆé—­ç¯ï¼‰ã€‚

**Q: ç‚¹äº‘å¤ªç¨€ç–ï¼Ÿ**
A: é»˜è®¤ä½“ç´ ç²¾åº¦ä¸º 1.5cmã€‚å¦‚éœ€æ›´é«˜ç²¾åº¦ï¼Œè¯·ä¿®æ”¹ä»£ç ä¸­çš„ `voxel_length` å‚æ•°ã€‚

---